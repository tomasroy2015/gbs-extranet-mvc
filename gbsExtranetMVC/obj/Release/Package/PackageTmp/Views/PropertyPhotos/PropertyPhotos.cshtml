@using Resources
@using MessageColumnCaptions
@model IEnumerable<gbsExtranetMVC.Models.Repositories.PropertyPhotosExt>
@{
    ViewBag.Title = "PropertyPhotos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<style type="text/css">
    .Photosbody {
        font-family: Verdana, Geneva, sans-serif;
        font-size: 13px;
        color: #333;
        background: url(../bg.jpg);
    }

    .FilterTable {
        -webkit-border-radius: 7px;
        -moz-border-radius: 7px;
        border-radius: 7px;
        background-color: #ece7cf;
        padding: 5px 10px 10px 10px;
        border: 1px solid #ddd7b4;
    }
</style>


<h1 style="color: black; text-align: center;">@MessageColumnCaptions.GetPageTitle("AdminHotelPhoto.aspx")</h1>
@*<h1 style="color: black; text-align: center;">Property Photos</h1>*@
@*<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/themes/smoothness/jquery-ui.min.css" rel="stylesheet" />*@
@*<link href="~/themes/base/jquery-ui.css" rel="stylesheet" />*@
<link href="~/CSS/jquery-ui.css" rel="stylesheet" />
<link rel="stylesheet" href="~/Scripts/PlUpload/jquery.ui.plupload/css/jquery.ui.plupload.css" type="text/css" />



@*<script src="~/Scripts/PlUpload/Script/jquery.min.js"></script>*@
@*<script src="~/Scripts/bootstrap.js"></script>*@
<script src="~/Scripts/PlUpload/Script/jquery-ui.min.js"></script>
@*<script src="~/Scripts/PlUpload/Script/browserplus-min.js"></script>*@
<script type="text/javascript" src="~/Scripts/PlUpload/plupload.js"></script>
    <script type="text/javascript" src="~/Scripts/PlUpload/plupload.gears.js"></script>
    <script type="text/javascript" src="~/Scripts/PlUpload/plupload.silverlight.js"></script>
    <script type="text/javascript" src="~/Scripts/PlUpload/plupload.flash.js"></script>  
    <script type="text/javascript" src="~/Scripts/PlUpload/plupload.browserplus.js"></script>
    <script type="text/javascript" src="~/Scripts/PlUpload/plupload.html4.js"></script>
    <script type="text/javascript" src="~/Scripts/PlUpload/plupload.html5.js"></script>
<script type="text/javascript" src="~/Scripts/PlUpload/jquery.ui.plupload/jquery.ui.plupload.js"></script>




@using (Html.BeginForm("PropertyPhotos", "PropertyPhotos", FormMethod.Post))
{

    <div id="qms-detail-table-wrapper" class="center Photosbody">
        <div class="table-responsive">
            <table align="center" style="width:100%;padding-left:3px;">
                <tr align="center">
                    <td>
                        <table align="center" border="0">
                            <tr align="center" style="font-weight:bold;color:blue;">

                                <td align="center" align="center" style="padding:8px;">
                                    <label style="color:blue;font-weight:bold;">[ </label>
                                    <a style="color: red; cursor: pointer" id="" onclick="GetHotelPhotos(@ViewBag.HotelID,1,'@Resources.HotelGeneralPhotos')">@Resources.HotelGeneralPhotos</a>
                                    <input type="hidden" id="hdnRecordID" value="@ViewBag.HotelID" />
                                    <input type="hidden" id="hdnPropertyName" value="@Resources.HotelGeneralPhotos" />
                                    <input type="hidden" id="hdnPartID" value="1" />
                                    <label style="color: blue;font-weight:bold;"> ]</label>
                                </td>
                                @foreach (var Rooms in ViewBag.HotelRooms)
                                {

                                    <td align="center" style="padding:8px;">
                                        <label style="color:blue;font-weight:bold;">[ </label>
                                        <a style="color:blue;cursor:pointer" onclick="GetHotelPhotos(@Rooms.RoomID,5,'@Rooms.RoomTypeName')">@Rooms.RoomTypeName</a>
                                        <label style="color:blue;font-weight:bold;">] </label>
                                    </td>
                                }
                            </tr>
                        </table>

                    </td>

                </tr>
                <tr align="center">
                    <td><label id="lblPhotosHeaderName" style="color: black; text-align: center;font-size:15px;font-weight:bold">@Resources.HotelGeneralPhotos</label></td>

                </tr>

            </table>
            <table align="center" border="0" style="width:100%;padding-left:3px;" id="tblListPhotos"></table>
            <table align="center" border="0" style="width:100%;padding-left:3px;" id="tblSaveButton">

                <tr>
                    <td>
                        <div align="center">
                            <a title='Click here to Save Photo Details' style='text-decoration:underline;'>
                                <input type="button" value="@Resources.Save" onclick="SavePropertyDetails()" class="k-button" style="width:200px; height:50px; background-color:#0062D9; color:white; font-weight:bold;" />
                            </a>
                            <br />
                            <label id="lblSuccess" style="color:green;font-size:medium;display:none;">@Resources.OperationSuccess</label>
                        </div>
                    </td>
                </tr>
            </table>
            <table align="center" style="width:100%;margin-top:20px;">
                <tr align="center" id="rowPhotoUpload" style="width:100%">
                    <td align="center" class="FilterTable">
                        <table style="width:100%">
                            <tr>
                                <td>
                                    <input id="btnReset" type="button" class="k-button" value="@Resources.NewPhotoUploadText" style="padding:10px;" />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="uploader">
                                        <p>
                                            YourBrowserDoesnotHaveFlash
                                            @*@Resources.YourBrowserDoesnotHaveFlash*@
                                        </p>
                                    </div>
                                    <div id="SuccessImage" style="margin: 0px auto; float: none;text-align:center;display:none">

                                        <label style="color:green;">@Resources.OperationSuccess</label>

                                    </div>
                                </td>
                            </tr>
                        </table>

                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="hidden" id="hdnFileName" />
                        <input type="hidden" id="hdnOperation" />
                    </td>

                </tr>

            </table>

        </div>


    </div>
    @*<div class="container">
         
 

  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog" style="display:none">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Modal Header</h4>
        </div>
        <div class="modal-body">
          <p>Some text in the modal.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
      
    </div>
  </div>
  
</div>*@

}




<script>
    var ViewBagHotelID = '@ViewBag.HotelID';
    var ViewBagPath = '@ViewBag.Path';
    var ViewBagCultureValue = '@ViewBag.CultureValue';
    var ViewBagMaxHotelPhotoCount = '@ViewBag.MaxHotelPhotoCount';
    var ViewBagAllowedPhotoFileExtensions = '@ViewBag.AllowedPhotoFileExtensions';
    var ViewBagMaxPhotoSize = '@ViewBag.MaxPhotoSize';

</script>


<script type="text/javascript">


    var maxfiles = ViewBagMaxHotelPhotoCount;
    var maxfileSize = ViewBagMaxPhotoSize + "mb";
    $(document).ready(function () { initUploader(); });
    var initUploader = function () {
       // alert("Start")
        $("#uploader").plupload({
            // General settings,silverlight,browserplus,html5gears,
            runtimes: 'html5,flash,browserplus,silverlight,gears,html4',
            url: '/PropertyPhotos/Upload',
            max_file_size: maxfileSize,
            unique_names: true,

            //resize : {width : <%=PhotoResizeWidth%>, height : <%=PhotoResizeHeight%>, quality : 92},

            // Specify what files to browse for
            filters: [
            { title: "Image files", extensions: ViewBagAllowedPhotoFileExtensions }
            ],

            // Flash settings
            flash_swf_url: '/Scripts/PlUpload/plupload.flash.swf',

            // Silverlight settings
            silverlight_xap_url: '/Scripts/PlUpload/plupload.silverlight.xap',

            init: {
                FilesAdded: function (up, files) {
                    plupload.each(files, function (file) {
                        if (up.files.length > maxfiles) {
                            up.removeFile(file);
                        }
                        var i = 0;
                        while (i <= up.files.length) {
                            ultimo = up.files.length;
                            if (ultimo > 1) {
                                if (i > 0) {
                                    ultimo2 = ultimo - 1;
                                    ii = i - 1;
                                    if (ultimo2 != ii) {
                                        if (up.files[ultimo - 1].name == up.files[i - 1].name) {
                                            up.removeFile(file);
                                        }
                                    }
                                }
                            }
                            i++;
                        }
                    });
                    //                    if (up.files.length >= maxfiles) {
                    //                        $('#uploader_browse').hide("slow");
                    //                    }
                },

                FilesRemoved: function (up, files) {
                    if (up.files.length < maxfiles) {
                        $('#uploader_browse').fadeIn("slow");
                    }
                },

                UploadComplete: function (up, file, info) {
                    var hdnFileName = document.getElementById('hdnFileName');
                    var hdnOperation = document.getElementById('hdnOperation');
                    for (i = 0; i < up.files.length; i++) {
                        hdnFileName.value += up.files[i].target_name + ';';
                    }
                    hdnOperation.value = 'Upload';
                    //alert(hdnFileName.value);
                    var Operation = hdnOperation.value;
                    var FileName = hdnFileName.value;
                    var PartID = document.getElementById('hdnPartID').value;
                    var RecordIdHdn = document.getElementById('hdnRecordID').value

                    var json = { Operation: Operation, FileName: FileName, PartID: PartID, RecordIdHdn: RecordIdHdn }
                    $.ajax({
                        type: "get",
                        url: "/PropertyPhotos/UploadOperation",
                        data: json,
                        datatype: "json",
                        success: function (res) {
                            if (res != "") {
                                document.getElementById('hdnFileName').value = "";
                                GetHotelPhotos("", "", "");
                                document.getElementById('SuccessImage').style.display = "block";
                                //up.destroy();
                                //initUploader();
                            }
                        }
                    })


                   // $('form').submit();
                }
            }
        });
        //tweak to reset the interface for new file upload, the core API didn't provide this functionality
        $('#btnReset').click(function () {
          
            var uploader = $('#uploader').plupload();
         //  alert(uploader)
           
            //clear files object
            // uploader.files.length = 0;
           // alert(uploader.files)
            //$.each(uploader.files, function (i, file) {
            //    uploader.removeFile(file);
            //});
            uploader.plupload('getUploader').splice();
            $('.plupload_filelist_content', uploader).empty();
             uploader.value = "";
            
             uploader.splice();
            // alert("ji")
            // uploader.refresh();
            $('div.plupload_buttons').css('display', 'block');
            $('span.plupload_upload_status').html('');
            $('span.plupload_upload_status').css('display', 'none');
            $('a.plupload_start').addClass('plupload_disabled');
             //alert("h3")
            //resetting the flash container css property
            //$('.flash').css({
            //    position: 'absolute', top: '292px',
            //    background: 'none repeat scroll 0% 0% transparent',
            //    width: '77px',
            //    height: '22px',
            //    left: '16px'
            //});
             //alert("hi")
            //clear the upload list
             $('#uploader_filelist tr').each(function (idx, val) {                
                 $(val).remove();
                 
             });
            
             document.getElementById('SuccessImage').style.display = "none";
            // up.destroy();
             //initUploader();
            // alert("h2")
            // uploader.files.length = 0;
            
        });
    };



</script>


<script>

    var MainphotoText = '@Resources.SetAsMainPhoto';

    $(document).ready(function () {
        GetHotelPhotos("", "", "");
    })

    function GetHotelPhotos(PropertyID, PartID, PropertyName) {

        if (PropertyID == "") {
            PropertyID = document.getElementById('hdnRecordID').value
            PartID = document.getElementById('hdnPartID').value
            PropertyName = document.getElementById('hdnPropertyName').value
        }
        else {
            document.getElementById('hdnRecordID').value = PropertyID;
            document.getElementById('hdnPartID').value = PartID;
            document.getElementById('hdnPropertyName').value = PropertyName;
        }
        //  alert(document.getElementById('hdnPropertyName').value);
        document.getElementById('lblPhotosHeaderName').innerHTML = document.getElementById('hdnPropertyName').value;

        var json = { PropertyID: PropertyID, PartID: PartID }
        $.ajax({
            type: "Get",
            url: "/PropertyPhotos/getListPhotos",
            data: json,
            datatype: "JSON",
            success: function (res) {
                $("#tblListPhotos").empty();
                if (res != "") {
                    document.getElementById('tblSaveButton').style.display = "";
                    $.each(res, function (key, val) {
                        $("#tblListPhotos").append(
                           '<div class="col-md-12">' +
                           '<div class="col-md-4 col-sm-6 col-xs-12" style="padding:10px;">' +
                           '<table style="width:100%;border:1px dotted gray;padding-left:3px;" id="tblListPhotos">' +
                           '<tr>' +
                           ' <td colspan="3" align="center" style="padding:3px;">' +
                                    '<a class="preview" href="/' + ViewBagPath + '' + ViewBagHotelID + '/' + val.Name + '"><img id="imgPhoto' + val.ID + '" style="width: 250px; height: 150px;" src="/' + ViewBagPath + '' + ViewBagHotelID + '/' + val.Name + '" /></a>' +
                           '</td>' +
                           '</tr>' +

                           '<tr>' +
                        '<td align="center" style="padding:3px;">' +
                            '<label id="lblSort">@Resources.Sort</label><br />' +
                            '<input type="text" style="width:100px" class="k-textbox" onblur="getValue(this)" name="txtPhoto" onchange="handleChange(this);" id="' + val.ID + '">' +
                            '<input type="hidden" id="hiddenSort' + val.ID + '" name="hidPhoto" value="' + val.ID + '">' +
                        '</td>' +
                         (val.MainPhoto == false ?
                            '<td style="padding:5px;white-space:nowrap;">' +
                               '<input type="button" id="lbtnMainPhoto' + val.ID + '" onclick="MainPhoto(' + val.ID + ')" class="k-button" value="'+MainphotoText+'">' +
                            '</td>' : '') +

                        '<td align="center" style="padding:3px;">' +
                            '<input type="button" id="lbtnDelete' + val.ID + '" onclick="Delete(' + val.ID + ')" class="k-button" value="@Resources.Delete">' +
                    '</td>' +
                   '</tr>' +
                    '<tr>' +
                        '<td colspan="3" align="center" style="padding:3px;">' +
                            '<input type="checkbox" id="cbxMarkToDelete' + val.ID + '" name="chphoto" value="' + val.ID + '" />@Resources.MarkAsDeleted' +
                            '<input type="hidden" id="hiddenReordID_' + val.ID + '" value="' + val.RecordID + '" />' +
                            '<input type="hidden" id="hiddenPartID_' + val.ID + '" value="' + val.PartID + '" />' +
                            '<input type="hidden" id="hiddenMarkToDelete_' + val.ID + ' value="' + val.ID + '" />' +
                        '</td>' +
                   ' </tr>' +

                    '</div>' +
                    '</div>'
                        );
                    })
                }
                else {
                    document.getElementById('tblSaveButton').style.display = "none";
                }
                setTimeout("imagePreview()", 2000);
            }
        })
    }


    function MainPhoto(id) {

        var ReordID = document.getElementById('hiddenReordID_' + id).value;

        var PartID = document.getElementById('hiddenPartID_' + id).value;

        var json = {
            ID: id, RecordID: ReordID, PartID: PartID
        }
        $.ajax({
            type: "Get",
            url: "/PropertyPhotos/SetMainPhoto",
            data: json,
            datatype: "JSON",
            success: function (res) {
                if (res != 0) {
                    document.getElementById("lblSuccess").style.display = "";
                    setTimeout("Hidelabel()", 2000);
                }
            }
        })

    }

    function Delete(id) {

        //  alert(id)

        var txt;
        var r = confirm("The Record will be deleted. Do you want cantinue?");
        if (r == true) {
            var checkboxes = document.getElementsByName('chphoto');
            var Photo = "";
            var vals = "";
            for (var i = 0, n = checkboxes.length; i < n; i++) {
                if (checkboxes[i].checked) {
                    vals += "," + checkboxes[i].value;

                }
            }

            Photo = vals;
            if (Photo == "") {
                Photo = id;
            }
            else {
                Photo = vals;
            }


            // alert(Photo)
            var json = {
                Photo: Photo
            }
            $.ajax({
                type: "Get",
                url: "/PropertyPhotos/DeletePhotos",
                data: json,
                datatype: "JSON",
                success: function (res) {
                    if (res != 0) {
                        document.getElementById("lblSuccess").style.display = "";
                        setTimeout("Hidelabel()", 2000);
                    }
                }
            })
        }
        else
        {

        }
        //alert(vals)
        //if (val) val = val.substring(1)

        //alert(val)
    }

    function SavePropertyDetails() {

        //   alert(Array);

        var checkboxes = document.getElementsByName('chphoto');
        var vals = "";
        for (var i = 0, n = checkboxes.length; i < n; i++) {
            if (checkboxes[i].checked) {
                vals += "," + checkboxes[i].value;

            }
        }

        var Photo = vals;


        var json = {
            Photo: Photo, PhValues: [Array2Save]
        }
        $.ajax({
            type: "Get",
            url: "/PropertyPhotos/SavePhotos",
            data: json,
            datatype: "JSON",
            traditional: true,
            success: function (res) {
                if (res != 0) {
                    document.getElementById("lblSuccess").style.display = "";
                    setTimeout("Hidelabel()", 2000);
                }
            }
        })

    }

    function Hidelabel() {
        document.getElementById("lblSuccess").style.display = "none";
        GetHotelPhotos("", "", "");
    }

    var Array2Save = [];
    function getValue(obj) {
        var Name = obj.id + ' ' + obj.value;
        Array2Save.push(Name);

    }

    function handleChange(input) {
        if (input.value < 1) input.value = 1;
        if (input.value > 100) input.value = 100;
    }


    /*

* Image preview script 
* powered by jQuery (http://www.jquery.com)
* 
* written by Alen Grakalic (http://cssglobe.com)
* 
* for more info visit http://cssglobe.com/post/1695/easiest-tooltip-and-image-preview-using-jquery
*
*/

    $(document).ready(function () {

        //  alert('Hi')
        setTimeout("imagePreview()", 5000);

        //  alert('Hi')
    });

    this.imagePreview = function () {

        /* CONFIG */
        xOffset = 10;
        yOffset = 10;

        // these 2 variable determine popup's distance from the cursor
        // you might want to adjust to get the right result

        /* END CONFIG */

        $("a.preview").hover(function (e) {

            //  this.t = this.title;
            //  this.title = "";
            //   var c = (this.t != "") ? "<br/>" + this.t : "";
            //  var c = "";
            $("body").append("<p id='preview'><img src='" + this.href + "' alt='Image preview' /></p>");

            var yPos = "top";
            var xPos = "left";
            var yCor = e.pageY - xOffset;
            var xCor = e.pageX + yOffset;
            var actualImgHeight = e.target.actualHeight;
            var actualImgWidth = e.target.actualWidth;
            var windowHeight = $(document).scrollTop() + $(window).height();
            var windowWidth = $(document).scrollLeft() + $(window).width();
            var imgWidth = 0;
            var imgHeight = 0;

            //alert(xCor + '-' + actualImgWidth + '-' + windowWidth);
            if (e.pageY + actualImgHeight + 20 > windowHeight) {
                if (e.pageY - actualImgHeight >= 0)
                    yCor = yCor - actualImgHeight;
            }

            if (e.pageX + actualImgWidth + 20 > windowWidth) {
                if (e.pageX - actualImgWidth >= 0)
                    xCor = xCor - actualImgWidth - 25;
            }

            $("#preview")
                .css("top", yCor + "px")
                .css("left", xCor + "px")
                .fadeIn();

        },

        function () {
            // this.title = this.t;
            $("#preview").remove();
        });

        $("a.preview").mousemove(function (e) {


            var yPos = "top";
            var xPos = "left";
            var yCor = e.pageY - xOffset;
            var xCor = e.pageX + yOffset;
            var actualImgHeight = e.target.actualHeight;
            var actualImgWidth = e.target.actualWidth;
            var windowHeight = $(document).scrollTop() + $(window).height();
            var windowWidth = $(document).scrollLeft() + $(window).width();

            if (e.pageY + actualImgHeight + 20 > windowHeight) {
                if (e.pageY - actualImgHeight >= 0)
                    yCor = yCor - actualImgHeight;
            }

            if (e.pageX + actualImgWidth + 20 > windowWidth) {
                if (e.pageX - actualImgWidth >= 0)
                    xCor = xCor - actualImgWidth - 25;
            }

            $("#preview")
                .css("top", yCor + "px")
                .css("left", xCor + "px")
                .fadeIn();


        });
    };
</script>

<style>
    #preview {
        position: absolute;
        border: 1px solid #ccc;
        background: #333;
        padding: 5px;
        display: none;
        color: #fff;
    }
</style>
<script type="text/javascript">

    var maxfiles = '@ViewBag.MaxHotelPhotoCount';
    var HotelID = '@ViewBag.HotelID';

    function path()
    {
        var json = { HotelID: HotelID }
        $.ajax({
            type: "get",
            url: "/PropertyPhotos/UploadImage",
            data: json,
            datatype: "json",
            success: function (res) {
                if (res != 0) {

                }
            }
        })
    }




</script>

<script type="text/jscript" language="jscript">

    function SetHotelPhoto(photoID, photoDimension) {
        var photo = document.getElementById(photoID);

        if (photo != null && photo.clientWidth > 0 && photo.clientHeight > 0 && !photo.processed) {
            var imgWidth = photo.clientWidth;
            var imgHeight = photo.clientHeight;

            photo.actualWidth = imgWidth;
            photo.actualHeight = imgHeight;

            if (imgWidth < imgHeight) {
                photo.style.width = photoDimension + "px";
                photo.style.height = ((imgHeight * photoDimension) / imgWidth) + "px";
            }
            else {
                photo.style.width = ((imgWidth * photoDimension) / imgHeight) + "px";
                photo.style.height = photoDimension + "px";
            }
            photo.processed = true;
        }
    }

</script>


<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-63530100-1', 'auto');
    ga('send', 'pageview');

</script>